<div class="page-container">
  <div class="page-header">
    <h1>Gestion des Questions</h1>
    <div class="header-actions">
      <select 
        [(ngModel)]="selectedCategoryId" 
        (change)="onCategoryFilterChange()"
        class="category-filter"
      >
        <option [ngValue]="null">Toutes les cat√©gories ({{ getTotalQuestionCount() }})</option>
        @for (category of categories(); track category.id) {
          <option [ngValue]="category.id">{{ category.name }} ({{ getQuestionCountByCategory(category.id) }})</option>
        }
      </select>
      
      <select 
        [(ngModel)]="selectedQuestionType" 
        (change)="onTypeFilterChange()"
        class="type-filter"
      >
        <option [ngValue]="null">Tous les types ({{ getTotalQuestionCount() }})</option>
        @for (type of questionTypes; track type.value) {
          <option [ngValue]="type.value">{{ type.label }} ({{ getQuestionCountByType(type.value) }})</option>
        }
      </select>

      <button (click)="openCreateForm()" class="btn-primary">
        ‚ûï Nouvelle Question
      </button>
    </div>
  </div>

  @if (error()) {
    <div class="error-message">{{ error() }}</div>
  }

  @if (loading() && questions().length === 0) {
    <div class="loading">Chargement...</div>
  } @else {
    <div class="questions-list">
      @for (question of questions(); track question.id) {
        <div class="question-card">
          <div class="question-header">
            <span class="category-badge">{{ getCategoryName(question.category_id) }}</span>
            <span class="type-badge">{{ question.question_type }}</span>
            @if (!question.is_active) {
              <span class="inactive-badge">Inactif</span>
            }
          </div>
          
          <div class="question-content">
            <h3>{{ question.question_text }}</h3>
            
            @if (question.question_type === 'map-click' && question.options?.imageUrl) {
              <div class="map-preview">
                <img [src]="question.options.imageUrl" alt="Carte" class="map-thumbnail">
              </div>
            } @else if (question.options) {
              <div class="options-preview">
                <strong>Options:</strong> {{ formatOptionsPreview(question.options, question.question_type) }}
              </div>
            }

            @if (question.tags && question.tags.length > 0) {
              <div class="tags">
                @for (tag of question.tags; track $index) {
                  <span class="tag">{{ tag }}</span>
                }
              </div>
            }

            @if (question.hint) {
              <p class="hint">üí° Indice: {{ question.hint }}</p>
            }
          </div>

          <div class="question-actions">
            <button (click)="openEditForm(question)" class="btn-edit">
              ‚úèÔ∏è Modifier
            </button>
            <button (click)="deleteQuestion(question)" class="btn-delete">
              üóëÔ∏è Supprimer
            </button>
          </div>
        </div>
      }
    </div>

    @if (questions().length === 0) {
      <div class="empty-state">
        <p>Aucune question pour le moment</p>
        <button (click)="openCreateForm()" class="btn-primary">
          Cr√©er la premi√®re question
        </button>
      </div>
    }
  }

  @if (showForm()) {
    <div class="modal-overlay" (click)="closeForm()">
      <div class="modal-content large" (click)="$event.stopPropagation()">
        <h2>{{ editingQuestion() ? 'Modifier' : 'Nouvelle' }} Question</h2>
        
        <form (ngSubmit)="onSubmit()">
          <div class="form-row">
            <div class="form-group">
              <label for="id">ID *</label>
              <input 
                type="text" 
                id="id" 
                [(ngModel)]="formData().id"
                name="id"
                required
                [disabled]="!!editingQuestion()"
                placeholder="q_histoire_1"
              >
            </div>

            <div class="form-group">
              <label for="category">Cat√©gorie *</label>
              <select 
                id="category" 
                [(ngModel)]="formData().category_id"
                name="category"
                required
              >
                @for (category of categories(); track category.id) {
                  <option [value]="category.id">{{ category.name }}</option>
                }
              </select>
            </div>

            <div class="form-group">
              <label for="type">Type *</label>
              <select 
                id="type" 
                [(ngModel)]="formData().question_type"
                name="type"
                required
                (change)="onTypeChange()"
              >
                @for (type of questionTypes; track type.value) {
                  <option [value]="type.value">{{ type.label }}</option>
                }
              </select>
            </div>
          </div>

          <div class="form-group">
            <label for="question">Question *</label>
            <textarea 
              id="question" 
              [(ngModel)]="formData().question_text"
              name="question"
              rows="3"
              required
              placeholder="Entrez votre question..."
            ></textarea>
          </div>

          <!-- Options QCM -->
          @if (formData().question_type === 'qcm') {
            <div class="options-section">
              <label>Options de r√©ponses</label>
              @for (option of qcmOptions(); track $index) {
                <div class="option-input">
                  <input 
                    type="text" 
                    [value]="option"
                    (input)="updateQcmOption($index, $any($event.target).value)"
                    placeholder="Option {{ $index + 1 }}"
                  >
                  @if (qcmOptions().length > 2) {
                    <button type="button" (click)="removeQcmOption($index)" class="btn-remove">‚úñ</button>
                  }
                </div>
              }
              <button type="button" (click)="addQcmOption()" class="btn-add">‚ûï Ajouter une option</button>
            </div>
          }

          <!-- Options Ordre -->
          @if (formData().question_type === 'ordre') {
            <div class="options-section">
              <label>Items √† ordonner</label>
              @for (item of ordreItems(); track $index) {
                <div class="option-input">
                  <span class="order-number">{{ $index + 1 }}.</span>
                  <input 
                    type="text" 
                    [value]="item"
                    (input)="updateOrdreItem($index, $any($event.target).value)"
                    placeholder="Item {{ $index + 1 }}"
                  >
                  @if (ordreItems().length > 2) {
                    <button type="button" (click)="removeOrdreItem($index)" class="btn-remove">‚úñ</button>
                  }
                </div>
              }
              <button type="button" (click)="addOrdreItem()" class="btn-add">‚ûï Ajouter un item</button>
            </div>
          }

          <!-- Options Timeline (Chronologie) -->
          @if (formData().question_type === 'timeline') {
            <div class="options-section">
              <div class="info-box" style="margin-bottom: 16px;">
                üìÖ <strong>Chronologie :</strong> Entre les √©v√©nements dans l'ordre chronologique correct (du plus ancien au plus r√©cent).
                La date est optionnelle mais aide √† afficher l'information.
              </div>
              <label>√âv√©nements chronologiques</label>
              @for (item of timelineItems(); track $index) {
                <div class="timeline-input">
                  <span class="order-number">{{ $index + 1 }}.</span>
                  <div class="timeline-fields">
                    <input 
                      type="text" 
                      [value]="item.text"
                      (input)="updateTimelineItem($index, 'text', $any($event.target).value)"
                      placeholder="Ex: D√©couverte de l'Am√©rique"
                      class="timeline-text"
                    >
                    <input 
                      type="text" 
                      [value]="item.date || ''"
                      (input)="updateTimelineItem($index, 'date', $any($event.target).value)"
                      placeholder="Ex: 1492 (optionnel)"
                      class="timeline-date"
                    >
                  </div>
                  @if (timelineItems().length > 2) {
                    <button type="button" (click)="removeTimelineItem($index)" class="btn-remove">‚úñ</button>
                  }
                </div>
              }
              <button type="button" (click)="addTimelineItem()" class="btn-add">‚ûï Ajouter un √©v√©nement</button>
            </div>
          }

          <!-- Options Association -->
          @if (formData().question_type === 'association') {
            <div class="association-full">
              <div class="info-box" style="margin-bottom: 16px;">
                ‚ÑπÔ∏è <strong>Association :</strong> D√©finis les items √† associer, puis les bonnes paires.
                Exemple : France ‚Üí Paris, Italie ‚Üí Rome
              </div>
              
              <div class="association-section">
                <div class="association-col">
                  <label>Colonne gauche (items √† associer)</label>
                  @for (item of associationLeft(); track $index) {
                    <div class="option-input">
                      <input 
                        type="text" 
                        [value]="item"
                        (input)="updateAssociationLeft($index, $any($event.target).value)"
                        placeholder="Ex: France"
                      >
                      @if (associationLeft().length > 2) {
                        <button type="button" (click)="removeAssociationLeft($index)" class="btn-remove">‚úñ</button>
                      }
                    </div>
                  }
                  <button type="button" (click)="addAssociationLeft()" class="btn-add-small">‚ûï Item</button>
                </div>

                <div class="association-col">
                  <label>Colonne droite (choix possibles)</label>
                  @for (item of associationRight(); track $index) {
                    <div class="option-input">
                      <input 
                        type="text" 
                        [value]="item"
                        (input)="updateAssociationRight($index, $any($event.target).value)"
                        placeholder="Ex: Paris"
                      >
                      @if (associationRight().length > 2) {
                        <button type="button" (click)="removeAssociationRight($index)" class="btn-remove">‚úñ</button>
                      }
                    </div>
                  }
                  <button type="button" (click)="addAssociationRight()" class="btn-add-small">‚ûï Item</button>
                </div>
              </div>

              <div class="pairs-section">
                <div class="pairs-header">
                  <label>üîó Bonnes correspondances</label>
                  <button type="button" (click)="autoGeneratePairs()" class="btn-auto">‚ö° Auto-g√©n√©rer</button>
                </div>
                <p class="pairs-help">
                  Pour chaque item de gauche, choisis le bon item de droite
                </p>
                @if (associationPairs().length === 0) {
                  <div class="info-box">
                    Cliquez sur "‚ö° Auto-g√©n√©rer" pour cr√©er automatiquement les lignes
                  </div>
                }
                @for (pair of associationPairs(); track $index) {
                  <div class="pair-input">
                    <select 
                      [(ngModel)]="pair.left"
                      [name]="'pair_left_' + $index"
                      class="pair-select"
                    >
                      <option value="">-- Item de gauche --</option>
                      @for (item of associationLeft(); track item) {
                        @if (item.trim()) {
                          <option [value]="item">{{ item }}</option>
                        }
                      }
                    </select>
                    <span class="arrow">‚Üí</span>
                    <select 
                      [(ngModel)]="pair.right"
                      [name]="'pair_right_' + $index"
                      class="pair-select"
                    >
                      <option value="">-- Item de droite --</option>
                      @for (item of associationRight(); track item) {
                        @if (item.trim()) {
                          <option [value]="item">{{ item }}</option>
                        }
                      }
                    </select>
                    <button type="button" (click)="removeAssociationPair($index)" class="btn-remove">‚úñ</button>
                  </div>
                }
                <button type="button" (click)="addAssociationPair()" class="btn-add">‚ûï Ajouter une correspondance</button>
              </div>
            </div>
          }

          <!-- Options Glisser-D√©poser -->
          @if (formData().question_type === 'glisser-deposer') {
            <div class="glisser-full">
              <div class="info-box" style="margin-bottom: 16px;">
                ‚ÑπÔ∏è <strong>Glisser-D√©poser :</strong> D√©finis les cat√©gories, les items, puis dans quelle cat√©gorie va chaque item.
                Exemple : Chat ‚Üí Mammif√®res, Serpent ‚Üí Reptiles
              </div>

              <div class="glisser-section">
                <div class="glisser-col">
                  <label>Cat√©gories (zones de d√©p√¥t)</label>
                  @for (cat of glisserCategories(); track $index) {
                    <div class="option-input">
                      <input 
                        type="text" 
                        [value]="cat"
                        (input)="updateGlisserCategory($index, $any($event.target).value)"
                        placeholder="Ex: Mammif√®res"
                      >
                      @if (glisserCategories().length > 2) {
                        <button type="button" (click)="removeGlisserCategory($index)" class="btn-remove">‚úñ</button>
                      }
                    </div>
                  }
                  <button type="button" (click)="addGlisserCategory()" class="btn-add-small">‚ûï Cat√©gorie</button>
                </div>

                <div class="glisser-col">
                  <label>Items √† classer</label>
                  @for (item of glisserItems(); track $index) {
                    <div class="option-input">
                      <input 
                        type="text" 
                        [value]="item"
                        (input)="updateGlisserItem($index, $any($event.target).value)"
                        placeholder="Ex: Chat"
                      >
                      @if (glisserItems().length > 2) {
                        <button type="button" (click)="removeGlisserItem($index)" class="btn-remove">‚úñ</button>
                      }
                    </div>
                  }
                  <button type="button" (click)="addGlisserItem()" class="btn-add-small">‚ûï Item</button>
                </div>
              </div>

              <div class="pairs-section">
                <div class="pairs-header">
                  <label>üéØ Classification correcte</label>
                  <button type="button" (click)="autoGenerateGlisserMapping()" class="btn-auto">‚ö° Auto-g√©n√©rer</button>
                </div>
                <p class="pairs-help">
                  Pour chaque item, choisis dans quelle cat√©gorie il doit aller
                </p>
                @if (glisserMapping().length === 0) {
                  <div class="info-box">
                    Cliquez sur "‚ö° Auto-g√©n√©rer" pour cr√©er automatiquement les lignes
                  </div>
                }
                @for (map of glisserMapping(); track $index) {
                  <div class="pair-input">
                    <select 
                      [(ngModel)]="map.item"
                      [name]="'glisser_item_' + $index"
                      class="pair-select"
                    >
                      <option value="">-- Choisir un item --</option>
                      @for (item of glisserItems(); track item) {
                        @if (item.trim()) {
                          <option [value]="item">{{ item }}</option>
                        }
                      }
                    </select>
                    <span class="arrow">‚Üí</span>
                    <select 
                      [(ngModel)]="map.category"
                      [name]="'glisser_cat_' + $index"
                      class="pair-select"
                    >
                      <option value="">-- Cat√©gorie --</option>
                      @for (cat of glisserCategories(); track cat) {
                        @if (cat.trim()) {
                          <option [value]="cat">{{ cat }}</option>
                        }
                      }
                    </select>
                    <button type="button" (click)="removeGlisserMapping($index)" class="btn-remove">‚úñ</button>
                  </div>
                }
                <button type="button" (click)="addGlisserMapping()" class="btn-add">‚ûï Ajouter une classification</button>
              </div>
            </div>
          }

          <!-- R√©ponse pour Vrai-Faux -->
          @if (formData().question_type === 'vrai-faux') {
            <div class="vraifaux-section">
              <label>Bonne r√©ponse *</label>
              <div class="vraifaux-buttons">
                <button 
                  type="button"
                  [class.active]="formData().answer === 'Vrai'"
                  (click)="setVraiFauxAnswer('Vrai')"
                  class="vraifaux-btn vrai-btn"
                >
                  ‚úì Vrai
                </button>
                <button 
                  type="button"
                  [class.active]="formData().answer === 'Faux'"
                  (click)="setVraiFauxAnswer('Faux')"
                  class="vraifaux-btn faux-btn"
                >
                  ‚úó Faux
                </button>
              </div>
            </div>
          }

          <!-- R√©ponse pour Input -->
          @if (formData().question_type === 'input') {
            <div class="form-group">
              <label for="answer">R√©ponse correcte *</label>
              <input 
                type="text" 
                id="answer" 
                [(ngModel)]="formData().answer"
                name="answer"
                required
                placeholder="La bonne r√©ponse"
              >
            </div>
          }

          <!-- Options Map-Click -->
          @if (formData().question_type === 'map-click') {
            <div class="mapclick-section">
              <div class="form-group">
                <label for="mapImage">Image de la carte *</label>
                <input 
                  type="file" 
                  id="mapImage"
                  accept="image/*"
                  (change)="onImageUpload($event)"
                >
                @if (uploadingImage()) {
                  <p class="upload-status">‚è≥ Upload et optimisation en cours...</p>
                }
                @if (mapImageUrl()) {
                  <p class="upload-status success">‚úÖ Image upload√©e</p>
                }
                <p class="help-text">L'image sera optimis√©e automatiquement (max 800px, <400KB, WebP)</p>
              </div>

              <div class="form-group">
                <label for="mapValidationMode">Mode de validation *</label>
                <select 
                  id="mapValidationMode"
                  [(ngModel)]="mapValidationMode" 
                  name="mapValidationMode"
                >
                  <option value="any">Une seule zone correcte suffit (mode "OU")</option>
                  <option value="all">Toutes les zones correctes doivent √™tre trouv√©es (mode "ET")</option>
                </select>
                <p class="help-text">
                  @if (mapValidationMode() === 'any') {
                    üí° Le joueur doit cliquer sur n'importe quelle zone marqu√©e comme correcte
                  } @else {
                    üí° Le joueur doit trouver et cliquer sur toutes les zones marqu√©es comme correctes
                  }
                </p>
              </div>

              @if (showCropTool()) {
                <div class="crop-tool-container">
                  <image-cropper
                    [imageChangedEvent]="mapImageEvent"
                    [maintainAspectRatio]="false"
                    [containWithinAspectRatio]="false"
                    [resizeToWidth]="800"
                    [cropperMinWidth]="50"
                    [cropperMinHeight]="50"
                    [onlyScaleDown]="true"
                    [roundCropper]="false"
                    [canvasRotation]="0"
                    [transform]="{}"
                    [alignImage]="'center'"
                    [backgroundColor]="'#000'"
                    [cropperStaticWidth]="0"
                    [cropperStaticHeight]="0"
                    format="png"
                    (imageCropped)="imageCropped($event)"
                    (imageLoaded)="imageLoaded()"
                    (cropperReady)="cropperReady()"
                    (loadImageFailed)="loadImageFailed()"
                  ></image-cropper>
                  
                  <div class="crop-actions" style="margin-top: 16px; display: flex; gap: 12px; justify-content: center;">
                    <button type="button" (click)="closeCropTool()" class="btn-secondary">
                      ‚ùå Annuler
                    </button>
                    <button type="button" (click)="applyCrop()" class="btn-primary">
                      ‚úÖ Appliquer le recadrage
                    </button>
                  </div>
                </div>
              }

              @if (mapImageUrl() && !showCropTool()) {
                <app-map-editor
                  [imageUrl]="mapImageUrl()"
                  [zones]="mapZones()"
                  (zonesChange)="onMapZonesChange($event)"
                ></app-map-editor>
                
                <button type="button" (click)="openCropTool()" class="btn-secondary" style="margin-top: 12px;">
                  ‚úÇÔ∏è Re-recadrer l'image
                </button>
              }

              @if (!mapImageUrl()) {
                <div class="info-box">
                  ‚ÑπÔ∏è Uploadez d'abord une image. Elle sera automatiquement crop√©e en 600x600, convertie en WebP et optimis√©e.
                </div>
              }
            </div>
          }

          <!-- R√©ponses pour Remplir-blancs -->
          @if (formData().question_type === 'remplir-blancs') {
            <div class="options-section">
              <label>R√©ponses accept√©es (plusieurs r√©ponses possibles)</label>
              <p class="help-text">Ajoute toutes les variations acceptables (ex: nectar, pollen, miel)</p>
              @for (answer of remplirBlancsAnswers(); track $index) {
                <div class="option-input">
                  <input 
                    type="text" 
                    [value]="answer"
                    (input)="updateRemplirBlancsAnswer($index, $any($event.target).value)"
                    placeholder="R√©ponse {{ $index + 1 }}"
                  >
                  @if (remplirBlancsAnswers().length > 1) {
                    <button type="button" (click)="removeRemplirBlancsAnswer($index)" class="btn-remove">‚úñ</button>
                  }
                </div>
              }
              <button type="button" (click)="addRemplirBlancsAnswer()" class="btn-add">‚ûï Ajouter une r√©ponse</button>
            </div>
          }

          <div class="form-group">
            <label for="tags">Tags (s√©par√©s par des virgules)</label>
            <input 
              type="text" 
              id="tags" 
              [value]="formData().tags.join(', ')"
              (input)="updateTags($any($event.target).value)"
              placeholder="g√©ographie, europe, capitales"
            >
          </div>

          <div class="form-group">
            <label for="hint">Indice</label>
            <input 
              type="text" 
              id="hint" 
              [(ngModel)]="formData().hint"
              name="hint"
              placeholder="Un petit indice..."
            >
          </div>

          <div class="form-group">
            <label>
              <input 
                type="checkbox" 
                [(ngModel)]="formData().is_active"
                name="is_active"
              >
              Question active
            </label>
          </div>

          <div class="form-actions">
            <button type="button" (click)="closeForm()" class="btn-secondary">
              Annuler
            </button>
            <button type="submit" class="btn-primary" [disabled]="loading()">
              {{ editingQuestion() ? 'Mettre √† jour' : 'Cr√©er' }}
            </button>
          </div>
        </form>
      </div>
    </div>
  }

  <!-- Bouton scroll to top -->
  @if (showScrollTop()) {
    <button (click)="scrollToTop()" class="scroll-top-btn" title="Remonter">
      ‚¨ÜÔ∏è
    </button>
  }
</div>
